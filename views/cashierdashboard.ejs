<!DOCTYPE html>
<html>
<head>
  <title>Dashboard - OSLAM</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #f4f8fb;
      margin: 0;
      color: #222;
      font-size: 15px;
    }
    .sidebar {
      width: 250px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      padding-top: 10px;
      padding: 12px;
      position: fixed;
      top: 20px;
      left: 20px;
      bottom: 20px;
      overflow-y: auto;
      border-left: 4px solid #0891b2;
    }
    .nav-link {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 18px;
      font-size: 15px;
      font-weight: 500;
      color: #333;
      border-radius: 10px;
      margin: 8px 10px;
      background: #fff;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      transition: all 0.25s ease;
      position: relative;
      position: relative: none;
    }
    .nav-link:hover,
    .nav-link.active {
      background: #e6f7fa;
      color: #0891b2;
      border-color: #b3e5ef;
      box-shadow: 0 3px 8px rgba(8,145,178,0.1);
    }
    .nav-link:hover::before,
    .nav-link.active::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: #0891b2;
      border-radius: 4px 0 0 4px;
    }
  </style>
  <style>
    body {
      background: #f5f7fa;
    }
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    .dashboard-title {
      font-size: 28px;
      font-weight: 600;
      color: #1a1a1a;
      margin: 0;
    }
    .header-controls {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .export-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: #0891b2;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }
    .export-btn:hover {
      background: #0e7490;
    }
    .export-btn i {
      font-size: 16px;
    }
    .filter-dropdown {
      position: relative;
    }
    .filter-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: white;
      color: #475569;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .filter-btn:hover {
      background: #f8fafc;
      border-color: #cbd5e1;
    }
    .filter-btn i {
      font-size: 16px;
    }
    .filter-menu {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 8px;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      min-width: 200px;
      display: none;
      z-index: 1000;
    }
    .filter-menu.show {
      display: block;
    }
    .filter-menu-header {
      padding: 12px 16px;
      border-bottom: 1px solid #e2e8f0;
      font-size: 13px;
      font-weight: 600;
      color: #1a1a1a;
    }
    .filter-menu-item {
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .filter-menu-item:hover {
      background: #f8fafc;
    }
    .filter-menu-item input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }
    .filter-menu-item label {
      font-size: 14px;
      color: #475569;
      cursor: pointer;
      user-select: none;
    }
    .date-filter {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 14px;
      color: #475569;
      cursor: pointer;
    }
    .date-filter i {
      font-size: 16px;
    }
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      border-bottom: 1px solid #e2e8f0;
      padding-bottom: 0;
    }
    .tab {
      padding: 12px 20px;
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      font-size: 14px;
      font-weight: 500;
      color: #64748b;
      cursor: pointer;
      transition: all 0.2s;
    }
    .tab.active {
      color: #0891b2;
      border-bottom-color: #0891b2;
    }
    .tab:hover {
      color: #0891b2;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 16px;
      margin-bottom: 32px;
    }
    .stat-card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
      transition: all 0.2s;
    }
    .stat-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transform: translateY(-2px);
    }
    .stat-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }
    .stat-title {
      font-size: 13px;
      font-weight: 500;
      color: #64748b;
      margin: 0;
    }
    .stat-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    .stat-icon.patients {
      background: #fff4e6;
      color: #f59e0b;
    }
    .stat-icon.admissions {
      background: #e0f2fe;
      color: #0284c7;
    }
    .stat-icon.revenue {
      background: #e0f2fe;
      color: #0284c7;
    }
    .stat-icon.income {
      background: #ecfdf5;
      color: #10b981;
    }
    .stat-icon.expenses {
      background: #e0f2fe;
      color: #0284c7;
    }
    .stat-value {
      font-size: 26px;
      font-weight: 700;
      color: #1a1a1a;
      margin: 6px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .stat-trend {
      font-size: 12px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .stat-trend.positive {
      color: #10b981;
    }
    .stat-trend.negative {
      color: #ef4444;
    }
    .stat-trend.neutral {
      color: #64748b;
    }
    .stat-subtitle {
      font-size: 12px;
      color: #94a3b8;
      margin-top: 4px;
    }
    .charts-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 32px;
    }
    .chart-card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
    }
    .chart-title {
      font-size: 15px;
      font-weight: 600;
      color: #1a1a1a;
      margin: 0 0 16px 0;
    }
    .chart-placeholder {
      width: 100%;
      height: 250px;
      background: #f8fafc;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #94a3b8;
    }
  </style>
</head>
<body>
  <!-- FLOATING SIDEBAR -->
  <aside class="sidebar">
    <div style="display:flex;align-items:center;gap:12px;padding:24px 20px 12px 20px;">
      <img src="/logo.png" style="width:44px;height:44px;border-radius:8px;object-fit:contain;">
      <div>
        <div style="font-size:20px;font-weight:700;color:#0891b2;">OsLAM</div>
        <div style="font-size:13px;color:#666;">Cashier</div>
      </div>
    </div>
     <nav style="margin-top:10px;">
      <ul style="list-style:none;padding:0;margin:0;">
        <li><a href="/cashierdashboard" class="nav-link"><i class="bi bi-grid"></i> Dashboard</a></li>
        <li><a href="/cashier" class="nav-link"><i class="bi bi-clock-history"></i> Pending Payments</a></li>
        <li><a href="/cashier/processed" class="nav-link"><i class="bi bi-check2-circle"></i> Processed Payment</a></li>
      </ul>
    </nav>

    <!-- Username and Email at Very Bottom, Plain Text -->
    <br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
    <div style="margin-bottom:18px;padding:0 18px 0 18px;text-align:left;">
      <div style="font-size:15px;font-weight:500;color:#222;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
        <%= (typeof username !== 'undefined' && username) ? username : 'Unknown User' %>
      </div>
      <div style="font-size:13px;color:#666;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
        <%= (typeof emailAddress !== 'undefined' && emailAddress) ? emailAddress : 'No Email' %>
      </div>
      <button onclick="window.location.href='/logout'" style="margin-top:10px;width:100%;background:none;border:none;padding:0;font-size:15px;font-weight:500;color:#0891b2;cursor:pointer;display:flex;align-items:center;gap:8px;">
        <i class="bi bi-box-arrow-right" style="font-size:18px;color:#0891b2;"></i> Log out
      </button>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <div class="main-container" style="margin-left:310px;">
    <!-- Header with Export and Date Filter -->
    <div class="dashboard-header">
      <h1 class="dashboard-title">Dashboard</h1>
      <div class="header-controls">
        <button class="export-btn" onclick="exportData()">
          <i class="bi bi-download"></i>
          <span>Export</span>
          <i class="bi bi-chevron-down" style="font-size: 12px;"></i>
        </button>
        
        <div class="filter-dropdown">
          <button class="filter-btn" onclick="toggleFilterMenu()">
            <i class="bi bi-funnel"></i>
          </button>
          <div class="filter-menu" id="filterMenu">
            <div class="filter-menu-header">Include in Export/Print</div>
            <div class="filter-menu-item" onclick="event.stopPropagation()">
              <input type="checkbox" id="includeCards" checked onchange="updateExportFilter()">
              <label for="includeCards">Statistics Cards</label>
            </div>
            <div class="filter-menu-item" onclick="event.stopPropagation()">
              <input type="checkbox" id="includeCharts" checked onchange="updateExportFilter()">
              <label for="includeCharts">Charts & Graphs</label>
            </div>
            <div class="filter-menu-item" onclick="event.stopPropagation()">
              <input type="checkbox" id="includeAnalytics" checked onchange="updateExportFilter()">
              <label for="includeAnalytics">Analytics</label>
            </div>
            <div class="filter-menu-item" onclick="event.stopPropagation()">
              <input type="checkbox" id="includeTable" checked onchange="updateExportFilter()">
              <label for="includeTable">Transaction Breakdown</label>
            </div>
          </div>
        </div>
        
        <div class="date-filter" style="display: flex; align-items: center; gap: 12px;">
          <i class="bi bi-calendar3"></i>
          <input type="date" id="startDate" style="border: none; background: transparent; font-size: 14px; color: #475569; cursor: pointer;" />
          <span style="color: #94a3b8;">to</span>
          <input type="date" id="endDate" style="border: none; background: transparent; font-size: 14px; color: #475569; cursor: pointer;" />
          <button onclick="applyDateFilter()" style="padding: 6px 12px; background: #0891b2; color: white; border: none; border-radius: 4px; font-size: 13px; cursor: pointer;">Apply</button>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('overview')">Overview</button>
      <button class="tab" onclick="switchTab('analytics')">Analytics</button>
    </div>

    <!-- Overview Tab Content -->
    <div id="overviewTab" class="tab-content active">
    <!-- Statistics Cards -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-header">
          <h3 class="stat-title">Total Patients</h3>
          <div class="stat-icon patients">
            <i class="bi bi-person-hearts"></i>
          </div>
        </div>
        <div class="stat-value">
          <%= (typeof stats.totalPatients === 'number') ? stats.totalPatients : 0 %>
        </div>
        <div class="stat-trend <%= stats.patientsTrend >= 0 ? 'positive' : 'negative' %>">
          <%= stats.patientsTrend >= 0 ? '+' : '' %><%= stats.patientsTrend || 0 %>% from last month
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-header">
          <h3 class="stat-title">Total Admissions</h3>
          <div class="stat-icon admissions">
            <i class="bi bi-wallet2"></i>
          </div>
        </div>
        <div class="stat-value">
          <%= (typeof stats.totalAdmissions === 'number') ? stats.totalAdmissions : 0 %>
        </div>
        <div class="stat-trend <%= stats.admissionsTrend >= 0 ? 'positive' : 'negative' %>">
          <%= stats.admissionsTrend >= 0 ? '+' : '' %><%= stats.admissionsTrend || -100 %>% from last month
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-header">
          <h3 class="stat-title">Total Revenue</h3>
          <div class="stat-icon revenue">
            <i class="bi bi-wallet2"></i>
          </div>
        </div>
        <div class="stat-value">
          ₱<%= (stats.totalRevenue || 0).toFixed(2) %>
        </div>
        <div class="stat-trend <%= stats.revenueTrend >= 0 ? 'positive' : 'negative' %>">
          <%= stats.revenueTrend >= 0 ? '+' : '' %><%= stats.revenueTrend || -100 %>% from last month
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-header">
          <h3 class="stat-title">Net Income</h3>
          <div class="stat-icon income">
            <i class="bi bi-graph-up-arrow"></i>
          </div>
        </div>
        <div class="stat-value">
          ₱<%= (stats.netIncome || 0).toFixed(2) %>
        </div>
        <div class="stat-trend <%= stats.incomeTrend >= 0 ? 'positive' : 'negative' %>">
          <%= stats.incomeTrend >= 0 ? '+' : '' %><%= stats.incomeTrend || -100 %>% from last month
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-header">
          <h3 class="stat-title">Expenses</h3>
          <div class="stat-icon expenses">
            <i class="bi bi-wallet2"></i>
          </div>
        </div>
        <div class="stat-value">
          ₱<%= (stats.expenses || 0).toFixed(2) %>
        </div>
        <div class="stat-trend neutral">
          <%= stats.expensesTrend || 0 %>% from last month
        </div>
        <div class="stat-subtitle"><%= stats.outstandingExpenses || 0 %> outstanding</div>
      </div>
    </div>

    <!-- Charts -->
    <div class="charts-grid">
      <div class="chart-card">
        <h3 class="chart-title">Admissions Breakdown</h3>
        <div class="chart-placeholder">
          <canvas id="admissionsChart"></canvas>
        </div>
      </div>

      <div class="chart-card">
        <h3 class="chart-title">Patient Source by Department</h3>
        <div class="chart-placeholder" style="display: flex; align-items: center; justify-content: center; position: relative; height: 250px;">
          <canvas id="demographicsChart" style="max-width: 250px; max-height: 250px;"></canvas>
        </div>
      </div>
    </div>

    <!-- Transactions Table -->
    <div class="chart-card" style="margin-top: 20px;">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <h3 class="chart-title" style="margin:0;">Discharged Patient Transactions</h3>
        <div style="display:flex; align-items:center; gap:8px;">
          <div style="position:relative;" id="txViewWrapper">
            <button id="txViewBtn" class="filter-btn" style="padding:6px 10px;" onclick="toggleTxViewMenu(event)">
              <i class="bi bi-eye"></i> View
            </button>
            <div class="filter-menu" id="txViewMenu" style="min-width:220px;">
              <div class="filter-menu-header">Show Columns</div>
              <div class="filter-menu-item" onclick="event.stopPropagation()">
                <input type="checkbox" id="colToggle-date" checked onchange="toggleTxColumn('date', this.checked)">
                <label for="colToggle-date">Date of Discharge</label>
              </div>
              <div class="filter-menu-item" onclick="event.stopPropagation()">
                <input type="checkbox" id="colToggle-patient" checked onchange="toggleTxColumn('patient', this.checked)">
                <label for="colToggle-patient">Patient Name</label>
              </div>
              <div class="filter-menu-item" onclick="event.stopPropagation()">
                <input type="checkbox" id="colToggle-desc" checked onchange="toggleTxColumn('desc', this.checked)">
                <label for="colToggle-desc">Description</label>
              </div>
              <div class="filter-menu-item" onclick="event.stopPropagation()">
                <input type="checkbox" id="colToggle-item" checked onchange="toggleTxColumn('item', this.checked)">
                <label for="colToggle-item">Item Amount</label>
              </div>
              <div class="filter-menu-item" onclick="event.stopPropagation()">
                <input type="checkbox" id="colToggle-proc" checked onchange="toggleTxColumn('proc', this.checked)">
                <label for="colToggle-proc">Procedure Amount</label>
              </div>
              <div class="filter-menu-item" onclick="event.stopPropagation()">
                <input type="checkbox" id="colToggle-total" checked onchange="toggleTxColumn('total', this.checked)">
                <label for="colToggle-total">Total Amount</label>
              </div>
              <div class="filter-menu-item" onclick="event.stopPropagation()">
                <input type="checkbox" id="colToggle-ratio" checked onchange="toggleTxColumn('ratio', this.checked)">
                <label for="colToggle-ratio">Charge Ratio (%)</label>
              </div>
            </div>
          </div>
          <input id="txSearch" type="text" placeholder="Search patient or description" 
                 style="border:1px solid #e2e8f0; border-radius:6px; padding:6px 10px; font-size:13px; color:#475569; width:240px;">
          <div style="display:flex; align-items:center; gap:6px; color:#64748b; font-size:13px;">
            Rows per page
            <select id="txRowsPerPage" style="border:1px solid #e2e8f0; border-radius:6px; padding:4px 8px;">
              <option>10</option>
              <option>25</option>
              <option>50</option>
              <option>100</option>
              <option value="all">All</option>
            </select>
          </div>
        </div>
      </div>
      <div style="overflow-x: auto; margin-top:10px;">
        <table id="txTable" style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: #f8fafc; border-bottom: 2px solid #e2e8f0;">
              <th class="col-date" style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; color: #475569;">Date of Discharge</th>
              <th class="col-patient" style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; color: #475569;">Patient Name</th>
              <th class="col-desc" style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; color: #475569;">Description</th>
              <th class="col-item" style="padding: 12px; text-align: right; font-size: 13px; font-weight: 600; color: #475569;">Item Amount</th>
              <th class="col-proc" style="padding: 12px; text-align: right; font-size: 13px; font-weight: 600; color: #475569;">Procedure Amount</th>
              <th class="col-total" style="padding: 12px; text-align: right; font-size: 13px; font-weight: 600; color: #475569;">Total Amount</th>
              <th class="col-ratio" style="padding: 12px; text-align: right; font-size: 13px; font-weight: 600; color: #475569;">Charge Ratio (%)</th>
            </tr>
          </thead>
          <tbody>
            <% 
            let totalItemAmount = 0;
            let totalProcedureAmount = 0;
            let totalTotalAmount = 0;
            
            transactions.forEach(tx => {
              totalItemAmount += tx.itemAmount;
              totalProcedureAmount += tx.procedureAmount;
              totalTotalAmount += tx.totalAmount;
            %>
            <tr class="tx-row" style="border-bottom: 1px solid #e2e8f0;">
              <td class="col-date" style="padding: 12px; font-size: 13px; color: #64748b;">
                <%= new Date(tx.date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) %>
              </td>
              <td class="col-patient" style="padding: 12px; font-size: 13px; color: #1a1a1a;">
                <%= tx.patientName %>
              </td>
              <td class="col-desc" style="padding: 12px; font-size: 13px; color: #475569;">
                <%= tx.description %>
              </td>
              <td class="col-item" style="padding: 12px; text-align: right; font-size: 13px; color: #475569;">
                ₱<%= tx.itemAmount.toFixed(2) %>
              </td>
              <td class="col-proc" style="padding: 12px; text-align: right; font-size: 13px; color: #475569;">
                ₱<%= tx.procedureAmount.toFixed(2) %>
              </td>
              <td class="col-total" style="padding: 12px; text-align: right; font-size: 13px; color: #1a1a1a; font-weight: 600;">
                ₱<%= tx.totalAmount.toFixed(2) %>
              </td>
              <td class="col-ratio" style="padding: 12px; text-align: right; font-size: 13px; color: #475569;">
                <% let ratio = 0; if (tx.totalAmount > 0) { ratio = (tx.procedureAmount / tx.totalAmount) * 100; } %>
                <%= ratio.toFixed(2) %>%
              </td>
            </tr>
            <% }); %>
          </tbody>
          <tfoot>
            <tr style="background: #f8fafc; border-top: 2px solid #e2e8f0;">
              <td class="col-date" style="padding: 16px; text-align: right; font-size: 14px; font-weight: 600; color: #1a1a1a;">
                TOTALS:
              </td>
              <td class="col-patient" style="padding: 16px;"></td>
              <td class="col-desc" style="padding: 16px;"></td>
              <td class="col-item" style="padding: 16px; text-align: right; font-size: 14px; font-weight: 700; color: #0284c7;">
                ₱<%= totalItemAmount.toFixed(2) %>
                <div style="font-size: 11px; font-weight: 500; color: #64748b; margin-top: 2px;">Total Expenses</div>
              </td>
              <td class="col-proc" style="padding: 16px; text-align: right; font-size: 14px; font-weight: 700; color: #10b981;">
                ₱<%= totalProcedureAmount.toFixed(2) %>
                <div style="font-size: 11px; font-weight: 500; color: #64748b; margin-top: 2px;">Net Income</div>
              </td>
              <td class="col-total" style="padding: 16px; text-align: right; font-size: 14px; font-weight: 700; color: #1a1a1a;">
                ₱<%= totalTotalAmount.toFixed(2) %>
                <div style="font-size: 11px; font-weight: 500; color: #64748b; margin-top: 2px;">Total Revenue</div>
              </td>
              <td class="col-ratio" style="padding: 16px; text-align: right; font-size: 14px; font-weight: 700; color: #1a1a1a;">
                <% let totalRatio = 0; if (totalTotalAmount > 0) { totalRatio = (totalProcedureAmount / totalTotalAmount) * 100; } %>
                <%= totalRatio.toFixed(2) %>%
              </td>
            </tr>
          </tfoot>
        </table>
        <div id="txPager" style="display:flex; align-items:center; justify-content:flex-end; gap:10px; margin-top:10px; color:#64748b; font-size:13px;">
          <span id="txPageInfo">Page 1 of 1</span>
          <button id="txPrev" class="filter-btn" style="padding:4px 8px;">&laquo;</button>
          <button id="txNext" class="filter-btn" style="padding:4px 8px;">&raquo;</button>
        </div>
      </div>
    </div>
    </div>
    <!-- End Overview Tab -->

    <!-- Analytics Tab Content -->
    <div id="analyticsTab" class="tab-content" style="display: none;">
      <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 24px;">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
          <i class="bi bi-graph-up" style="font-size: 24px; color: #0891b2;"></i>
          <h2 style="font-size: 20px; font-weight: 600; color: #1a1a1a; margin: 0;">Actionable Analytics & KPI Insights</h2>
        </div>
        
        <% 
          // Generate dynamic insights based on stats
          const insights = [];
          
          // Net Income Analysis
          if (stats.netIncome < 10000) {
            insights.push({
              type: 'warning',
              icon: 'bi-exclamation-circle',
              title: 'Action Needed',
              message: `Net income is below ₱10,000. Review expenses and revenue sources.`,
              color: '#fff4e6',
              textColor: '#f59e0b'
            });
          } else if (stats.netIncome > 50000) {
            insights.push({
              type: 'success',
              icon: 'bi-check-circle',
              title: 'Strong Performance',
              message: `Net income is ₱${stats.netIncome.toFixed(2)}. Excellent financial health.`,
              color: '#ecfdf5',
              textColor: '#10b981'
            });
          }
          
          // Revenue Analysis (show total revenue and status)
          const totalRevenueVal = Number(stats.totalRevenue || 0);
          if (totalRevenueVal < 10000) {
            insights.push({
              type: 'warning',
              icon: 'bi-exclamation-circle',
              title: 'Action Needed',
              message: `Total revenue is ₱${totalRevenueVal.toFixed(2)}. Review expenses and revenue sources.`,
              color: '#fff4e6',
              textColor: '#f59e0b'
            });
          } else {
            insights.push({
              type: 'success',
              icon: 'bi-check-circle',
              title: 'Financially Stable',
              message: `Total revenue is ₱${totalRevenueVal.toFixed(2)}. The hospital is considered financially stable.`,
              color: '#ecfdf5',
              textColor: '#10b981'
            });
          }

          // Registration vs Discharge Analysis
          const regCounts = (chartData && chartData.registeredCounts) || [];
          const disCounts = (chartData && chartData.dischargedCounts) || [];
          const totalRegistered = regCounts.reduce((s, n) => s + Number(n || 0), 0);
          const totalDischarged = disCounts.reduce((s, n) => s + Number(n || 0), 0);
          const diff = Math.abs(totalRegistered - totalDischarged);
          const maxVal = Math.max(totalRegistered, totalDischarged, 1);
          const isClose = diff / maxVal <= 0.1; // within 10%
          if (totalRegistered > totalDischarged && totalRegistered > 0) {
            insights.push({
              type: 'warning',
              icon: 'bi-exclamation-circle',
              title: 'Pending Discharges',
              message: `Registrations (${totalRegistered}) exceed discharges (${totalDischarged}). Please review pending billing, medical clearance, and discharge processing to avoid delays.`,
              color: '#fff4e6',
              textColor: '#f59e0b'
            });
          } else if (isClose && (totalRegistered + totalDischarged) > 0) {
            insights.push({
              type: 'info',
              icon: 'bi-info-circle',
              title: 'Balanced Flow',
              message: `Registrations (${totalRegistered}) and discharges (${totalDischarged}) are close. Continue monitoring for efficiency and ensure discharge processing remains timely.`,
              color: '#e0f2fe',
              textColor: '#0284c7'
            });
          }
          
          // Admissions Analysis
          if (stats.totalAdmissions === 0) {
            insights.push({
              type: 'info',
              icon: 'bi-info-circle',
              title: 'FYI',
              message: `Admissions are low this month (${stats.totalAdmissions}). Consider outreach or marketing.`,
              color: '#e0f2fe',
              textColor: '#0284c7'
            });
          } else if (stats.totalAdmissions > 20) {
            insights.push({
              type: 'success',
              icon: 'bi-check-circle',
              title: 'High Volume',
              message: `${stats.totalAdmissions} admissions this period. Ensure adequate staffing.`,
              color: '#ecfdf5',
              textColor: '#10b981'
            });
          }
          
          // Patient Growth
          if (stats.patientsTrend < 0) {
            insights.push({
              type: 'warning',
              icon: 'bi-exclamation-circle',
              title: 'Declining Patients',
              message: `Patient registrations down ${Math.abs(stats.patientsTrend)}%. Review patient satisfaction and marketing.`,
              color: '#fff4e6',
              textColor: '#f59e0b'
            });
          } else if (stats.patientsTrend > 10) {
            insights.push({
              type: 'success',
              icon: 'bi-check-circle',
              title: 'Growing Patient Base',
              message: `Patient registrations up ${stats.patientsTrend}%. Continue current strategies.`,
              color: '#ecfdf5',
              textColor: '#10b981'
            });
          }
          
          // Expense Analysis
          if (stats.expenses > stats.totalRevenue * 0.8) {
            insights.push({
              type: 'warning',
              icon: 'bi-exclamation-circle',
              title: 'High Expense Ratio',
              message: `Expenses are ${((stats.expenses/stats.totalRevenue)*100).toFixed(1)}% of revenue. Review cost optimization opportunities.`,
              color: '#fff4e6',
              textColor: '#f59e0b'
            });
          }
          
          // Revenue Forecast (7-day moving average + recency-weighted)
          try {
            const labelsArr = (chartData && chartData.labels) || [];
            const revenueSeries = (chartData && chartData.revenueSeries) || [];
            const n = revenueSeries.length;
            if (n > 0) {
              const windowSize = Math.min(7, n);
              const slice = revenueSeries.slice(-windowSize);
              const mean = slice.reduce((s,v)=>s+Number(v||0),0) / windowSize;

              // Recency-weighted average (linear weights 1..windowSize)
              let wSum = 0, wxSum = 0;
              for (let i=0;i<windowSize;i++) {
                const w = i+1; // newest has largest weight
                wSum += w;
                wxSum += w * Number(slice[i] || 0);
              }
              const weightedAvg = wxSum / (wSum || 1);

              const tomorrowPH = new Intl.DateTimeFormat('en-US', { year: 'numeric', month: 'short', day: 'numeric', timeZone: 'Asia/Manila' }).format(new Date(Date.now() + 24*60*60*1000));
              const maLabel = windowSize >= 7 ? '7-day MA' : `${windowSize}-day MA`;

              insights.push({
                type: 'info',
                icon: 'bi-bar-chart-steps',
                title: 'Revenue Forecast',
                message: `Forecast for ${tomorrowPH}: ₱${mean.toFixed(2)} (${maLabel}), ₱${weightedAvg.toFixed(2)} (recency-weighted).`,
                color: '#e0f2fe',
                textColor: '#0284c7'
              });
            }
          } catch (e) { /* no-op */ }
          
          // Default insight if nothing triggered
          if (insights.length === 0) {
            insights.push({
              type: 'info',
              icon: 'bi-info-circle',
              title: 'Performance Summary',
              message: `All metrics within normal ranges for the selected period.`,
              color: '#e0f2fe',
              textColor: '#0284c7'
            });
          }
        %>
        
        <div style="display: flex; flex-direction: column; gap: 16px;">
          <% insights.forEach(insight => { %>
            <div style="background: <%= insight.color %>; border-left: 4px solid <%= insight.textColor %>; padding: 16px 20px; border-radius: 8px;">
              <div style="display: flex; align-items: flex-start; gap: 12px;">
                <i class="<%= insight.icon %>" style="font-size: 20px; color: <%= insight.textColor %>; margin-top: 2px;"></i>
                <div style="flex: 1;">
                  <h4 style="font-size: 15px; font-weight: 600; color: #1a1a1a; margin: 0 0 6px 0;"><%= insight.title %></h4>
                  <p style="font-size: 14px; color: #475569; margin: 0; line-height: 1.5;"><%= insight.message %></p>
                </div>
              </div>
            </div>
          <% }); %>
        </div>
      </div>
    </div>
    <!-- End Analytics Tab -->

  </div>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Socket.io real-time dashboard refresh
    const socket = io();
    socket.on('dashboardRefresh', () => {
      console.log('Dashboard refresh triggered');
      window.location.reload();
    });

    // Export filter settings
    let exportSettings = {
      includeCards: true,
      includeCharts: true,
      includeAnalytics: true,
      includeTable: true
    };

    function toggleFilterMenu() {
      const menu = document.getElementById('filterMenu');
      menu.classList.toggle('show');
      
      // Close menu when clicking outside
      if (menu.classList.contains('show')) {
        setTimeout(() => {
          document.addEventListener('click', closeFilterMenu);
        }, 0);
      }
    }

    function closeFilterMenu(e) {
      const menu = document.getElementById('filterMenu');
      const filterBtn = event.target.closest('.filter-btn');
      if (!filterBtn && !menu.contains(e.target)) {
        menu.classList.remove('show');
        document.removeEventListener('click', closeFilterMenu);
      }
    }

    function updateExportFilter() {
      exportSettings.includeCards = document.getElementById('includeCards').checked;
      exportSettings.includeCharts = document.getElementById('includeCharts').checked;
      exportSettings.includeAnalytics = document.getElementById('includeAnalytics').checked;
      exportSettings.includeTable = document.getElementById('includeTable').checked;
      console.log('Export settings updated:', exportSettings);
    }

    function exportData() {
      // Close filter menu
      document.getElementById('filterMenu').classList.remove('show');
      
      // Check which sections are selected
      if (!exportSettings.includeCards && !exportSettings.includeCharts && !exportSettings.includeAnalytics && !exportSettings.includeTable) {
        alert('Please select at least one section to export');
        toggleFilterMenu();
        return;
      }
      
      // Build preview content
      let previewContent = '<div style="padding: 15px; max-width: 1000px; margin: 0 auto;">';
      previewContent += '<h2 style="text-align: center; margin-bottom: 15px; font-size: 16px;">Dashboard Export Preview</h2>';
      
      // Include Statistics Cards
      if (exportSettings.includeCards) {
        previewContent += '<h3 style="font-size: 12px; margin-bottom: 10px;">Statistics</h3>';
        previewContent += '<div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 20px;">';
        document.querySelectorAll('.stat-card').forEach(card => {
          previewContent += '<div style="border: 1px solid #e2e8f0; padding: 10px; border-radius: 6px; font-size: 0.7em;">';
          previewContent += card.innerHTML;
          previewContent += '</div>';
        });
        previewContent += '</div>';
      }
      
      // Include Charts
      if (exportSettings.includeCharts) {
        previewContent += '<h3 style="font-size: 12px; margin-bottom: 10px;">Charts & Graphs</h3>';
        previewContent += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">';
        const admissionsCanvas = document.getElementById('admissionsChart');
  const demographicsCanvas = document.getElementById('demographicsChart');
        if (admissionsCanvas) {
          previewContent += '<div style="border: 1px solid #e2e8f0; padding: 10px; border-radius: 6px;">';
          previewContent += '<strong style="display: block; margin-bottom: 6px; font-size: 11px;">Admissions Breakdown</strong>';
          previewContent += '<img src="' + admissionsCanvas.toDataURL() + '" style="width: 100%; height: auto; max-height: 140px; object-fit: contain;">';
          previewContent += '</div>';
        }
        if (demographicsCanvas) {
          previewContent += '<div style="border: 1px solid #e2e8f0; padding: 10px; border-radius: 6px;">';
          previewContent += '<strong style="display: block; margin-bottom: 6px; font-size: 11px;">Patient Source by Department</strong>';
          previewContent += '<img src="' + demographicsCanvas.toDataURL() + '" style="width: 100%; height: auto; max-height: 140px; object-fit: contain;">';
          previewContent += '</div>';
        }
        previewContent += '</div>';
      }
      
      // Include Analytics
      if (exportSettings.includeAnalytics) {
        previewContent += '<h3 style="font-size: 12px; margin-bottom: 10px;">Actionable Analytics & KPI Insights</h3>';
        const analyticsSection = document.querySelector('#analyticsTab > div');
        if (analyticsSection) {
          previewContent += '<div style="background: white; padding: 16px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 20px; font-size: 0.9em;">';
          // Get all insight cards
          const insightCards = analyticsSection.querySelectorAll('div[style*="border-left"]');
          insightCards.forEach(card => {
            previewContent += card.outerHTML;
          });
          previewContent += '</div>';
        }
      }
      
      // Include Transaction Table
      if (exportSettings.includeTable) {
        previewContent += '<h3 style="font-size: 12px; margin-bottom: 10px;">Transaction Breakdown</h3>';
        const table = document.getElementById('txTable');
        if (table) {
          // Clone the table to show ALL rows for export/print
          const tableClone = table.cloneNode(true);
          // Show all rows in the clone (remove any display:none from pagination)
          const allCloneRows = tableClone.querySelectorAll('tbody .tx-row');
          allCloneRows.forEach(r => r.style.display = '');
          previewContent += '<div style="overflow-x: auto;">' + tableClone.outerHTML + '</div>';
        }
      }
      
      previewContent += '</div>';
      
      // Open preview in new window
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Dashboard Export - Preview</title>
          <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
          <style>
            body { font-family: Arial, sans-serif; margin: 0; padding: 15px; font-size: 11px; }
            h2, h3 { color: #1a1a1a; }
            table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 10px; }
            th, td { padding: 6px; text-align: left; border: 1px solid #e2e8f0; }
            th { background: #f8fafc; font-weight: 600; }
            .no-print { margin: 15px 0; text-align: center; }
            .no-print button { padding: 8px 16px; margin: 0 4px; font-size: 12px; cursor: pointer; }
            @media print { 
              .no-print { display: none; }
              body { padding: 8px; font-size: 10px; }
              h2 { font-size: 14px; }
              h3 { font-size: 11px; }
              table { font-size: 9px; }
              th, td { padding: 4px; }
            }
          </style>
        </head>
        <body>
          <div class="no-print">
            <button onclick="window.print()" style="background: #0891b2; color: white; border: none; border-radius: 4px;">Print</button>
            <button onclick="window.close()" style="background: #64748b; color: white; border: none; border-radius: 4px;">Close</button>
          </div>
          ${previewContent}
        </body>
        </html>
      `);
      printWindow.document.close();
    }

    // Initialize date inputs with current range or default to last 30 days
    const urlParams = new URLSearchParams(window.location.search);
    const startParam = urlParams.get('startDate');
    const endParam = urlParams.get('endDate');
    
    const today = new Date();
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(today.getDate() - 29);
    
    document.getElementById('startDate').value = startParam || thirtyDaysAgo.toISOString().split('T')[0];
    document.getElementById('endDate').value = endParam || today.toISOString().split('T')[0];

    function applyDateFilter() {
      const start = document.getElementById('startDate').value;
      const end = document.getElementById('endDate').value;
      
      if (!start || !end) {
        alert('Please select both start and end dates');
        return;
      }
      
      if (new Date(start) > new Date(end)) {
        alert('Start date must be before end date');
        return;
      }
      
  window.location.href = `/cashierdashboard?startDate=${start}&endDate=${end}`;
    }

    function switchTab(tab) {
      // Update tab buttons
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      
      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
        content.style.display = 'none';
      });
      
      if (tab === 'overview') {
        document.getElementById('overviewTab').classList.add('active');
        document.getElementById('overviewTab').style.display = 'block';
      } else if (tab === 'analytics') {
        document.getElementById('analyticsTab').classList.add('active');
        document.getElementById('analyticsTab').style.display = 'block';
      }
    }

    // Render Admissions Breakdown line chart
    (function renderAdmissionsChart() {
      try {
        const labels = <%- JSON.stringify((chartData && chartData.labels) || []) %>;
        const registered = <%- JSON.stringify((chartData && chartData.registeredCounts) || []) %>;
        const discharged = <%- JSON.stringify((chartData && chartData.dischargedCounts) || []) %>;

        const ctx = document.getElementById('admissionsChart').getContext('2d');
        // Set canvas height for professional sizing
        document.getElementById('admissionsChart').style.height = '230px';

        new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels.map(lbl => new Date(lbl).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
            datasets: [
              {
                label: 'Registered Patients',
                data: registered,
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.15)',
                pointBackgroundColor: '#3b82f6',
                pointRadius: 3,
                borderWidth: 2,
                tension: 0.3,
                fill: true
              },
              {
                label: 'Discharged Patients',
                data: discharged,
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.15)',
                pointBackgroundColor: '#10b981',
                pointRadius: 3,
                borderWidth: 2,
                tension: 0.3,
                fill: true
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
              legend: { position: 'top' },
              tooltip: { enabled: true }
            },
            scales: {
              x: { grid: { display: false } },
              y: { beginAtZero: true, ticks: { precision: 0 } }
            }
          }
        });
      } catch (e) {
        console.warn('Chart render failed:', e);
      }
    })();

    // Render Department Distribution Pie Chart
    (function renderDemographicsChart() {
      try {
  const dept = <%- JSON.stringify((typeof departmentData !== 'undefined') ? departmentData : { labels: [], counts: [] }) %>;
        const labels = Array.isArray(dept.labels) ? dept.labels : [];
        const dataCounts = Array.isArray(dept.counts) ? dept.counts : [];
        const total = dataCounts.reduce((s, n) => s + (Number(n) || 0), 0);
        
        if (total === 0) {
          document.getElementById('demographicsChart').parentElement.innerHTML = 
            '<div style="color: #94a3b8; font-size: 14px;">No department data for selected period</div>';
          return;
        }

        const ctx = document.getElementById('demographicsChart').getContext('2d');
        const palette = ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#06b6d4','#84cc16','#f97316','#e11d48'];
        const bgColors = labels.map((_, i) => palette[i % palette.length]);
        
        new Chart(ctx, {
          type: 'pie',
          data: {
            labels: labels,
            datasets: [{
              data: dataCounts,
              backgroundColor: bgColors,
              borderColor: bgColors.map(()=> '#ffffff'),
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  padding: 15,
                  font: { size: 13 },
                  color: '#64748b'
                }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const label = context.label || '';
                    const value = context.parsed || 0;
                    const percent = ((value / total) * 100).toFixed(1);
                    return `${label}: ${value} patients (${percent}%)`;
                  }
                }
              }
            }
          }
        });
      } catch (e) {
        console.warn('Department pie chart render failed:', e);
      }
    })();

    // Transactions Table: View menu, column toggles, search, and pagination
    (function initTransactionsTableUI() {
      const table = document.getElementById('txTable');
      if (!table) return; // safety

      const tbody = table.querySelector('tbody');
      const allRows = Array.from(tbody.querySelectorAll('.tx-row'));
      const searchInput = document.getElementById('txSearch');
      const rowsPerPageSelect = document.getElementById('txRowsPerPage');
      const pageInfo = document.getElementById('txPageInfo');
      const prevBtn = document.getElementById('txPrev');
      const nextBtn = document.getElementById('txNext');

      let state = {
        search: '',
        perPage: parseRowsPerPage(rowsPerPageSelect?.value || '10'),
        page: 1
      };

      function parseRowsPerPage(val){
        return (val === 'all') ? Infinity : Math.max(1, parseInt(val || '10', 10));
      }

      function rowMatches(row, term){
        if (!term) return true;
        const patient = (row.querySelector('.col-patient')?.textContent || '').toLowerCase();
        const desc = (row.querySelector('.col-desc')?.textContent || '').toLowerCase();
        return patient.includes(term) || desc.includes(term);
      }

      function apply(){
        const term = state.search.trim().toLowerCase();
        const filtered = allRows.filter(r => rowMatches(r, term));

        const total = filtered.length;
        const perPage = state.perPage === Infinity ? total || 1 : state.perPage;
        const totalPages = Math.max(1, Math.ceil(total / perPage));
        state.page = Math.min(Math.max(1, state.page), totalPages);

        // hide all first
        allRows.forEach(r => r.style.display = 'none');

        // show current page slice
        const startIdx = (state.page - 1) * perPage;
        const endIdx = state.perPage === Infinity ? total : Math.min(startIdx + perPage, total);
        for (let i = startIdx; i < endIdx; i++) {
          const row = filtered[i];
          if (row) row.style.display = '';
        }

        // update pager UI
        if (pageInfo) pageInfo.textContent = `Page ${state.page} of ${totalPages}`;
        if (prevBtn) prevBtn.disabled = state.page <= 1;
        if (nextBtn) nextBtn.disabled = state.page >= totalPages;
      }

      // Event listeners
      if (searchInput) searchInput.addEventListener('input', () => {
        state.search = searchInput.value || '';
        state.page = 1;
        apply();
      });

      if (rowsPerPageSelect) rowsPerPageSelect.addEventListener('change', () => {
        state.perPage = parseRowsPerPage(rowsPerPageSelect.value);
        state.page = 1;
        apply();
      });

      if (prevBtn) prevBtn.addEventListener('click', () => { state.page--; apply(); });
      if (nextBtn) nextBtn.addEventListener('click', () => { state.page++; apply(); });

      // Initial render
      apply();
    })();

    // View dropdown for transactions table
    function toggleUserDropdown() {
      const menu = document.getElementById('userDropdownMenu');
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    }
    function logout() {
      window.location.href = '/logout'; // Redirect to logout route
    }
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.user-dropdown')) {
        const menu = document.getElementById('userDropdownMenu');
        if (menu) menu.style.display = 'none';
      }
    });
    function toggleTxViewMenu(event){
      const menu = document.getElementById('txViewMenu');
      if (!menu) return;
      menu.classList.toggle('show');
      if (menu.classList.contains('show')){
        setTimeout(()=>document.addEventListener('click', txViewOutside), 0);
      }
      event.stopPropagation();
    }

    function txViewOutside(e){
      const menu = document.getElementById('txViewMenu');
      const btn = document.getElementById('txViewBtn');
      if (!menu || !btn) return;
      if (!menu.contains(e.target) && e.target !== btn){
        menu.classList.remove('show');
        document.removeEventListener('click', txViewOutside);
      }
    }

    function toggleTxColumn(key, show){
      const th = document.querySelector(`#txTable thead .col-${key}`);
      const tds = document.querySelectorAll(`#txTable tbody .col-${key}, #txTable tfoot .col-${key}`);
      const display = show ? '' : 'none';
      if (th) th.style.display = display;
      tds.forEach(td => td.style.display = display);
    }
  </script>
</body>
</html>
