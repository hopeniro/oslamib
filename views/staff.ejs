<!DOCTYPE html>
<html>
<head>
  <title>Staff Management</title>
  <link rel="stylesheet" type="text/css" href="/css/main.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    body {
      background: #f5f7fa;
    }
    .main-content-box {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      padding: 32px;
      max-width: 1100px;
      margin: 40px auto;
    }
  </style>
<style>
    body {
      background: #f5f7fa;
    }
    .promissory-image {
      max-width: 200px;
      max-height: 200px;
      cursor: pointer;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .status-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }
    .status-pending { background: #FFC107; color: #000; }
    .status-approved { background: #4CAF50; color: #fff; }
    .status-settled { background: #2196F3; color: #fff; }
    .status-overdue { background: #f44336; color: #fff; }
  .status-rejected { background: #9E9E9E; color: #fff; }
    .action-btn {
      padding: 6px 12px;
      margin: 2px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .btn-approve { background: #4CAF50; color: white; }
    .btn-edit { background: #2196F3; color: white; }
    .btn-settle { background: #9C27B0; color: white; }
    .btn-overdue { background: #f44336; color: white; }
  </style>
<style>
    body {
      font-family: 'Inter', sans-serif;
      background: #f4f8fb;
      margin: 0;
      color: #222;
      font-size: 15px;
    }
    /* SIDEBAR & NAV ONLY */
    .sidebar {
      width: 250px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      padding-top: 10px;
      padding: 12px;
      position: fixed;
      top: 20px;
      left: 20px;
      bottom: 20px;
      overflow-y: auto;
      border-left: 4px solid #0891b2;
    }
    .nav-link {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 18px;
      font-size: 15px;
      font-weight: 500;
      color: #333;
      border-radius: 10px;
      margin: 8px 10px;
      background: #fff;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      transition: all 0.25s ease;
      position: relative;
      text-decoration: none;
    }
    .nav-link:hover,
    .nav-link.active {
      background: #e6f7fa;
      color: #0891b2;
      border-color: #b3e5ef;
      box-shadow: 0 3px 8px rgba(8,145,178,0.1);
    }
    .nav-link:hover::before,
    .nav-link.active::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: #0891b2; /* OsLAM title color */
      border-radius: 4px 0 0 4px;
      box-shadow: 0 0 0 1px #0891b2;
    }
  </style>
</head>
<body>
   <!-- FLOATING SIDEBAR -->
  <aside class="sidebar">
    <div style="display:flex;align-items:center;gap:12px;padding:24px 20px 12px 20px;">
      <img src="/logo.png" style="width:44px;height:44px;border-radius:8px;object-fit:contain;">
      <div>
        <div style="font-size:20px;font-weight:700;color:#0891b2;">OsLAM</div>
        <div style="font-size:13px;color:#666;">Billing</div>
      </div>
    </div>
    <nav style="margin-top:10px;">
      <ul style="list-style:none;padding:0;margin:0;">
        <li><a href="/dashboard" class="nav-link"><i class="bi bi-grid"></i> Dashboard</a></li>
        <li><a href="/promissory" class="nav-link"><i class="bi bi-file-earmark-text"></i> Promissory Notes</a></li>
        <li><a href="/services" class="nav-link"><i class="bi bi-tools"></i> Services</a></li>
         <li><a href="/doctor" class="nav-link"><i class="bi bi-person-badge"></i> Doctors</a></li>
        <li><a href="/nurse" class="nav-link"><i class="bi bi-person-lines-fill"></i> Nurses</a></li>
         <li><a href="/doctorscheduling" class="nav-link"><i class="bi bi-calendar-event"></i> Doctor Schedule</a></li>
        <li><a href="/nursescheduling" class="nav-link"><i class="bi bi-calendar-event"></i> Nurse Schedule</a></li>
         <li><a href="/staff" class="nav-link"><i class="bi bi-people"></i> Staff</a></li>
        <li><a href="/audittrail" class="nav-link"><i class="bi bi-shield-check"></i> Audit Trail</a></li>
      </ul>
    </nav>
  </aside>


<div style="margin-left: 260px;">
  <!-- Removed outer wrap box, only main content remains -->
  <div class="form-section main-content-box">
      <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 15px;">
        <div class="tab-group">
          <button type="button" class="btn btn-primary btn-tab" data-tab="staff" onclick="openStaffModal()">Add Staff</button>
        </div>
      </div>

    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom: 16px;">
      <h2 style="margin:0;">Staff</h2>
      <div style="display:flex; align-items:center; gap:8px;">
        <div style="position:relative;" id="staffViewWrapper">
          <button id="staffViewBtn" onclick="toggleStaffViewMenu(event)" style="padding:6px 12px; cursor:pointer; border:1px solid #ccc; background:white; border-radius:4px;">
            <i class="bi bi-eye"></i> View
          </button>
          <div id="staffViewMenu" style="display:none; position:absolute; right:0; top:100%; margin-top:4px; background:white; border:1px solid #ccc; border-radius:4px; box-shadow:0 2px 8px rgba(0,0,0,0.15); min-width:220px; z-index:1000;">
            <div style="padding:8px 12px; border-bottom:1px solid #eee; font-weight:600; font-size:13px;">Show Columns</div>
            <div style="padding:6px 12px;" onclick="event.stopPropagation()"><input type="checkbox" id="staffToggle-id" checked onchange="toggleStaffColumn('id', this.checked)"> <label for="staffToggle-id">Staff ID</label></div>
            <div style="padding:6px 12px;" onclick="event.stopPropagation()"><input type="checkbox" id="staffToggle-name" checked onchange="toggleStaffColumn('name', this.checked)"> <label for="staffToggle-name">Name</label></div>
            <div style="padding:6px 12px;" onclick="event.stopPropagation()"><input type="checkbox" id="staffToggle-birth" checked onchange="toggleStaffColumn('birth', this.checked)"> <label for="staffToggle-birth">Date of Birth</label></div>
            <div style="padding:6px 12px;" onclick="event.stopPropagation()"><input type="checkbox" id="staffToggle-gender" checked onchange="toggleStaffColumn('gender', this.checked)"> <label for="staffToggle-gender">Gender</label></div>
            <div style="padding:6px 12px;" onclick="event.stopPropagation()"><input type="checkbox" id="staffToggle-civil" checked onchange="toggleStaffColumn('civil', this.checked)"> <label for="staffToggle-civil">Civil Status</label></div>
            <div style="padding:6px 12px;" onclick="event.stopPropagation()"><input type="checkbox" id="staffToggle-nationality" checked onchange="toggleStaffColumn('nationality', this.checked)"> <label for="staffToggle-nationality">Nationality</label></div>
            <div style="padding:6px 12px;" onclick="event.stopPropagation()"><input type="checkbox" id="staffToggle-contact" checked onchange="toggleStaffColumn('contact', this.checked)"> <label for="staffToggle-contact">Contact</label></div>
            <div style="padding:6px 12px;" onclick="event.stopPropagation()"><input type="checkbox" id="staffToggle-email" checked onchange="toggleStaffColumn('email', this.checked)"> <label for="staffToggle-email">Email</label></div>
            <div style="padding:6px 12px;" onclick="event.stopPropagation()"><input type="checkbox" id="staffToggle-address" checked onchange="toggleStaffColumn('address', this.checked)"> <label for="staffToggle-address">Address</label></div>
            <div style="padding:6px 12px;" onclick="event.stopPropagation()"><input type="checkbox" id="staffToggle-status" checked onchange="toggleStaffColumn('status', this.checked)"> <label for="staffToggle-status">Status</label></div>
          </div>
        </div>
        <input id="staffSearch" type="text" placeholder="Search name or email" style="border:1px solid #ccc; border-radius:4px; padding:6px 10px; font-size:13px; width:200px;">
        <div style="display:flex; align-items:center; gap:6px; font-size:13px;">
          Rows per page
          <select id="staffRowsPerPage" style="border:1px solid #ccc; border-radius:4px; padding:4px 8px;">
            <option>10</option>
            <option>25</option>
            <option>50</option>
            <option>100</option>
            <option value="all">All</option>
          </select>
        </div>
      </div>
    </div>

    <table id="staffTable">
      <thead>
      <tr>
        <th class="col-id">Staff ID</th>
        <th class="col-name">Full Name</th>
        <th class="col-birth">Date of Birth</th>
        <th class="col-gender">Gender</th>
        <th class="col-civil">Civil Status</th>
        <th class="col-nationality">Nationality</th>
        <th class="col-contact">Contact Number</th>
        <th class="col-email">Email Address</th>
        <th class="col-address">Home Address</th>
        <th class="col-status">Action</th>
      </tr>
      </thead>
      <tbody>
      <% staff.forEach(s => { %>
        <tr class="staff-row">
          <td class="col-id"><%= s.staffId %></td>
          <td class="col-name"><%= s.lastName %>, <%= s.firstName %> <%= s.middleName || '' %></td>
          <td class="col-birth"><%= new Date(s.dateOfBirth).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) %></td>
          <td class="col-gender"><%= s.gender %></td>
          <td class="col-civil"><%= s.civilStatus %></td>
          <td class="col-nationality"><%= s.nationality %></td>
          <td class="col-contact"><%= s.contactNumber %></td>
          <td class="col-email"><%= s.emailAddress %></td>
          <td class="col-address"><%= s.homeAddress %></td>
          <td class="col-status">
            <button class="btn btn-primary" onclick='openManageModal(<%= JSON.stringify({
              staffId: s.staffId,
              firstName: s.firstName,
              middleName: s.middleName || "",
              lastName: s.lastName,
              fullName: s.lastName + ", " + s.firstName + " " + (s.middleName || ""),
              dateOfBirth: s.dateOfBirth,
              gender: s.gender,
              civilStatus: s.civilStatus,
              nationality: s.nationality,
              contactNumber: s.contactNumber,
              emailAddress: s.emailAddress,
              homeAddress: s.homeAddress,
              category: s.category || "",
              username: s.username || "",
              status: s.status || "inactive"
            }) %>)'>Manage</button>
          </td>
        </tr>
      <% }) %>
      </tbody>
    </table>

    <div id="staffPager" style="display:flex; align-items:center; justify-content:flex-end; gap:10px; margin-top:10px; font-size:13px; color:#666;">
      <span id="staffPageInfo">Page 1 of 1</span>
      <button id="staffPrev" style="padding:4px 8px; cursor:pointer;">&laquo;</button>
      <button id="staffNext" style="padding:4px 8px; cursor:pointer;">&raquo;</button>
    </div>
  </div>

  <!-- Staff Registration Modal -->
  <div id="staff-modal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="staffModalTitle">
      <button class="modal-close" onclick="closeStaffModal()" aria-label="Close">&times;</button>
      <h3 id="staffModalTitle" style="margin-top: 0;">Register Staff</h3>
      <form id="staffForm" action="/register-staff" method="POST">
        <div class="form-grid grid-2">
          <div class="form-field">
            <label for="firstName">First Name</label>
            <input type="text" id="firstName" name="firstName" required>
          </div>
          <div class="form-field">
            <label for="middleName">Middle Name</label>
            <input type="text" id="middleName" name="middleName">
          </div>

          <div class="form-field">
            <label for="lastName">Last Name</label>
            <input type="text" id="lastName" name="lastName" required>
          </div>
          <div class="form-field">
            <label for="dateOfBirth">Date of Birth</label>
            <input type="date" id="dateOfBirth" name="dateOfBirth" required>
          </div>

          <div class="form-field">
            <label for="gender">Gender</label>
            <select id="gender" name="gender" required>
              <option value="">-- Select Gender --</option>
              <option>Male</option><option>Female</option>
            </select>
          </div>
          <div class="form-field">
            <label for="civilStatus">Civil Status</label>
            <select id="civilStatus" name="civilStatus" required>
              <option value="">-- Select Civil Status --</option>
              <option>Single</option>
              <option>Married</option>
              <option>Widowed</option>
              <option>Divorced</option>
              <option>Separated</option>
            </select>
          </div>

          <div class="form-field">
            <label for="nationality">Nationality</label>
            <input type="text" id="nationality" name="nationality" required>
          </div>
          <div class="form-field">
            <label for="contactNumber">Contact Number</label>
            <input type="tel" id="contactNumber" name="contactNumber" required inputmode="numeric" pattern="\d{11}" minlength="11" maxlength="11" title="Enter exactly 11 digits (e.g., 09123456789)">
            <div class="help-text">11-digit number (e.g., 09123456789)</div>
          </div>

          <div class="form-field full">
            <label for="emailAddress">Email Address</label>
            <input type="email" id="emailAddress" name="emailAddress" required title="Enter a valid email address (e.g., user@example.com)">
          </div>

          <div class="form-field full">
            <label for="homeAddress">Home Address</label>
            <input type="text" id="homeAddress" name="homeAddress" required>
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-cancel" onclick="closeStaffModal()">Cancel</button>
          <button type="submit" class="btn btn-white">Register Staff</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Staff Manage Modal -->
  <div id="manage-modal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="manageModalTitle">
      <button class="modal-close" onclick="closeManageModal()" aria-label="Close">&times;</button>
      <h3 id="manageModalTitle" style="margin-top: 0;">Manage Staff</h3>
      <form id="manageForm" action="/manage-staff" method="POST">
        <input type="hidden" id="manageStaffId" name="staffId">
        
        <div class="form-field">
          <label style="font-weight: 600; margin-bottom: 8px; display: block;">Staff ID</label>
          <div id="displayStaffId" style="padding: 8px; background: #f5f5f5; border-radius: 4px; font-size: 15px;"></div>
        </div>

        <div class="form-field" style="margin-top: 16px;">
          <label style="font-weight: 600; margin-bottom: 8px; display: block;">Full Name</label>
          <div id="displayFullName" style="padding: 8px; background: #f5f5f5; border-radius: 4px; font-size: 15px;"></div>
        </div>

        <div class="form-field" style="margin-top: 16px;">
          <label for="manageCategory">Category</label>
          <select id="manageCategory" name="category" required>
            <option value="">-- Select Category --</option>
            <option value="Triage">Triage</option>
            <option value="Admission">Admission</option>
            <option value="Out Patient Department">Out Patient Department</option>
            <option value="Emergency Department">Emergency Department</option>
            <option value="Billing">Billing</option>
            <option value="Cashier">Cashier</option>
            <option value="Admin">Admin</option>
          </select>
        </div>

        <div class="form-field" style="margin-top: 16px;">
          <label for="manageUsername">Username</label>
          <input type="text" id="manageUsername" name="username" required>
        </div>

        <div class="form-field" style="margin-top: 16px;">
          <label for="managePassword">Password</label>
          <div style="position: relative;">
            <input type="password" id="managePassword" name="password" placeholder="Leave blank to keep current password" style="padding-right: 40px;">
            <i class="bi bi-eye" id="togglePassword" onclick="togglePasswordVisibility()" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 18px; color: #666;"></i>
          </div>
          <div style="margin-top: 4px;">
            <a href="javascript:void(0)" onclick="restorePassword()" style="font-size: 12px; color: #007bff; text-decoration: none;">Restore Password</a>
          </div>
        </div>

        <div class="form-field" style="margin-top: 16px;">
          <label style="font-weight: 600; margin-bottom: 8px; display: block;">Status</label>
          <div style="display: flex; align-items: center; gap: 12px;">
            <label class="toggle-switch">
              <input type="checkbox" id="manageStatusToggle" name="statusToggle">
              <span class="toggle-slider"></span>
            </label>
            <span id="statusLabel" style="font-size: 14px; color: #666;">Inactive</span>
          </div>
        </div>

        <div class="modal-actions" style="margin-top: 24px;">
          <button type="button" class="btn btn-primary" onclick="updateStaff()" style="background: #007bff;">Update</button>
          <button type="button" class="btn btn-primary" onclick="deleteStaff()" style="background: #dc3545;">Delete</button>
          <button type="submit" class="btn btn-white">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
  .toggle-switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
  }
  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }
  .toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: 0.4s;
    border-radius: 24px;
  }
  .toggle-slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.4s;
    border-radius: 50%;
  }
  .toggle-switch input:checked + .toggle-slider {
    background-color: #4CAF50;
  }
  .toggle-switch input:checked + .toggle-slider:before {
    transform: translateX(26px);
  }
</style>

<script>
  // ================= Table UI: View/Search/Pagination =================
  function toggleStaffViewMenu(event){
    const menu = document.getElementById('staffViewMenu');
    if (!menu) return;
    const isShown = menu.style.display === 'block';
    menu.style.display = isShown ? 'none' : 'block';
    if (!isShown){
      setTimeout(()=>document.addEventListener('click', staffViewOutside), 0);
    }
    event.stopPropagation();
  }
  function staffViewOutside(e){
    const menu = document.getElementById('staffViewMenu');
    const btn = document.getElementById('staffViewBtn');
    if (!menu || !btn) return;
    if (!menu.contains(e.target) && e.target !== btn){
      menu.style.display = 'none';
      document.removeEventListener('click', staffViewOutside);
    }
  }
  function toggleStaffColumn(key, show) {
    const table = document.getElementById('staffTable');
    const th = table.querySelector(`thead .col-${key}`);
    const tds = table.querySelectorAll(`tbody .col-${key}`);
    const display = show ? '' : 'none';
    if (th) th.style.display = display;
    tds.forEach(td => td.style.display = display);
  }

  (function initStaffTableUI(){
    const tbody = document.querySelector('#staffTable tbody');
    const allRows = Array.from(tbody.querySelectorAll('tr.staff-row'));
    const searchInput = document.getElementById('staffSearch');
    const rowsPerSelect = document.getElementById('staffRowsPerPage');
    const pageInfo = document.getElementById('staffPageInfo');
    const prevBtn = document.getElementById('staffPrev');
    const nextBtn = document.getElementById('staffNext');

    let filtered = allRows.slice();
    let currentPage = 1;
    let rowsPerPage = parseRowsPer(rowsPerSelect.value);
    function parseRowsPer(v){ return v === 'all' ? Infinity : parseInt(v,10); }

    function render(){
      allRows.forEach(r => r.style.display = 'none');
      const total = filtered.length;
      const totalPages = Math.max(1, Math.ceil(total / (rowsPerPage || Infinity)));
      if (currentPage > totalPages) currentPage = totalPages;
      const start = (currentPage-1) * (rowsPerPage || Infinity);
      const end = rowsPerPage === Infinity ? total : start + rowsPerPage;
      filtered.slice(start, end).forEach(r => r.style.display = '');
      if (pageInfo) pageInfo.textContent = `Page ${total===0?0:currentPage} of ${total===0?0:totalPages}`;
      if (prevBtn) prevBtn.disabled = currentPage <= 1 || total === 0;
      if (nextBtn) nextBtn.disabled = currentPage >= totalPages || total === 0;
    }

    function applySearch(){
      const q = (searchInput.value||'').toLowerCase();
      if (!q) filtered = allRows.slice();
      else {
        filtered = allRows.filter(r => {
          const name = (r.querySelector('.col-name')?.textContent||'').toLowerCase();
          const email = (r.querySelector('.col-email')?.textContent||'').toLowerCase();
          return name.includes(q) || email.includes(q);
        });
      }
      currentPage = 1; render();
    }

    searchInput?.addEventListener('input', applySearch);
    rowsPerSelect?.addEventListener('change', ()=>{ rowsPerPage = parseRowsPer(rowsPerSelect.value); currentPage=1; render(); });
    prevBtn?.addEventListener('click', ()=>{ if(currentPage>1){ currentPage--; render(); }});
    nextBtn?.addEventListener('click', ()=>{ currentPage++; render(); });

    applySearch();
  })();

  function setActiveTab(name) {
    const tabs = document.querySelectorAll('.btn-tab');
    tabs.forEach(b => b.classList.remove('is-active'));
    const btn = document.querySelector(`.btn-tab[data-tab="${name}"]`);
    if (btn) btn.classList.add('is-active');
  }

  function clearActiveTabs() {
    document.querySelectorAll('.btn-tab').forEach(b => b.classList.remove('is-active'));
  }

  // Modal open/close handlers
  function openStaffModal() {
    const modal = document.getElementById('staff-modal');
    const form = document.getElementById('staffForm');
    
    // Reset form for new registration
    form.reset();
    form.action = '/register-staff';
    document.getElementById('staffModalTitle').textContent = 'Register Staff';
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.textContent = 'Register Staff';
    
    // Remove staffId hidden field if exists
    const hiddenInput = form.querySelector('input[name="staffId"]');
    if (hiddenInput) {
      hiddenInput.remove();
    }
    
    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden', 'false');
    const first = modal.querySelector('input[name="firstName"]');
    if (first) { setTimeout(() => first.focus(), 0); }
    setActiveTab('staff');
  }
  function closeStaffModal() {
    const modal = document.getElementById('staff-modal');
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden', 'true');
    clearActiveTabs();
  }

  function openManageModal(staffData) {
    // Store staff data globally for update/delete functions
    window.currentStaffData = staffData;
    
    const modal = document.getElementById('manage-modal');
    document.getElementById('manageStaffId').value = staffData.staffId;
    document.getElementById('displayStaffId').textContent = staffData.staffId;
    document.getElementById('displayFullName').textContent = staffData.fullName;
    document.getElementById('manageCategory').value = staffData.category || '';
    document.getElementById('manageUsername').value = staffData.username || '';
    document.getElementById('managePassword').value = ''; // Always empty for security
    
    const toggle = document.getElementById('manageStatusToggle');
    const label = document.getElementById('statusLabel');
    if (staffData.status === 'active') {
      toggle.checked = true;
      label.textContent = 'Active';
      label.style.color = '#4CAF50';
    } else {
      toggle.checked = false;
      label.textContent = 'Inactive';
      label.style.color = '#666';
    }
    
    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden', 'false');
  }

  function updateStaff() {
    if (!window.currentStaffData) return;
    
    const data = window.currentStaffData;
    
    // Close manage modal
    closeManageModal();
    
    // Open staff registration modal with pre-filled data
    const modal = document.getElementById('staff-modal');
    document.getElementById('firstName').value = data.firstName;
    document.getElementById('middleName').value = data.middleName;
    document.getElementById('lastName').value = data.lastName;
    document.getElementById('dateOfBirth').value = data.dateOfBirth ? new Date(data.dateOfBirth).toISOString().split('T')[0] : '';
    document.getElementById('gender').value = data.gender;
    document.getElementById('civilStatus').value = data.civilStatus;
    document.getElementById('nationality').value = data.nationality;
    document.getElementById('contactNumber').value = data.contactNumber;
    document.getElementById('emailAddress').value = data.emailAddress;
    document.getElementById('homeAddress').value = data.homeAddress;
    
    // Change form action to update route and add hidden field for staffId
    const form = document.getElementById('staffForm');
    let hiddenInput = form.querySelector('input[name="staffId"]');
    if (!hiddenInput) {
      hiddenInput = document.createElement('input');
      hiddenInput.type = 'hidden';
      hiddenInput.name = 'staffId';
      form.insertBefore(hiddenInput, form.firstChild);
    }
    hiddenInput.value = data.staffId;
    form.action = '/update-staff';
    
    // Change modal title
    document.getElementById('staffModalTitle').textContent = 'Update Staff';
    
    // Change button text
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.textContent = 'Update Staff';
    
    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden', 'false');
    setActiveTab('staff');
  }

  function deleteStaff() {
    if (!window.currentStaffData) return;
    
    if (confirm(`Are you sure you want to delete ${window.currentStaffData.fullName}? This action cannot be undone.`)) {
      // Create form and submit
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '/delete-staff';
      
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'staffId';
      input.value = window.currentStaffData.staffId;
      
      form.appendChild(input);
      document.body.appendChild(form);
      form.submit();
    }
  }

  function closeManageModal() {
    const modal = document.getElementById('manage-modal');
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden', 'true');
  }

  function togglePasswordVisibility() {
    const passwordInput = document.getElementById('managePassword');
    const toggleIcon = document.getElementById('togglePassword');
    
    if (passwordInput.type === 'password') {
      passwordInput.type = 'text';
      toggleIcon.classList.remove('bi-eye');
      toggleIcon.classList.add('bi-eye-slash');
    } else {
      passwordInput.type = 'password';
      toggleIcon.classList.remove('bi-eye-slash');
      toggleIcon.classList.add('bi-eye');
    }
  }

  async function restorePassword() {
    if (!window.currentStaffData) return;
    
    if (confirm(`Reset password to default "password" for ${window.currentStaffData.fullName}?`)) {
      try {
        const response = await axios.post('/restore-staff-password', {
          staffId: window.currentStaffData.staffId
        });
        
        if (response.data.success) {
          alert('Password has been reset to "password"');
          // Show it in the field temporarily
          const passwordInput = document.getElementById('managePassword');
          passwordInput.value = 'password';
          passwordInput.type = 'text';
          const toggleIcon = document.getElementById('togglePassword');
          toggleIcon.classList.remove('bi-eye');
          toggleIcon.classList.add('bi-eye-slash');
        }
      } catch (err) {
        alert(err.response?.data?.error || 'Failed to restore password');
      }
    }
  }

  // Update status label when toggle changes
  document.addEventListener('DOMContentLoaded', function() {
    const toggle = document.getElementById('manageStatusToggle');
    const label = document.getElementById('statusLabel');
    if (toggle && label) {
      toggle.addEventListener('change', function() {
        if (this.checked) {
          label.textContent = 'Active';
          label.style.color = '#4CAF50';
        } else {
          label.textContent = 'Inactive';
          label.style.color = '#666';
        }
      });
    }
  });

  // Close when clicking outside the modal content
  window.addEventListener('click', function(event) {
    const staffModal = document.getElementById('staff-modal');
    const manageModal = document.getElementById('manage-modal');
    if (event.target === staffModal) {
      closeStaffModal();
    }
    if (event.target === manageModal) {
      closeManageModal();
    }
  });
  // Close on Escape key
  window.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      const staffModal = document.getElementById('staff-modal');
      const manageModal = document.getElementById('manage-modal');
      if (staffModal && staffModal.style.display === 'flex') {
        closeStaffModal();
      }
      if (manageModal && manageModal.style.display === 'flex') {
        closeManageModal();
      }
    }
  });

  // Enforce numeric-only and 11-digit limit on contact field
  (function () {
    const contactInput = document.getElementById('contactNumber');
    if (contactInput) {
      contactInput.addEventListener('input', function () {
        this.value = this.value.replace(/\D/g, '').slice(0, 11);
      });
    }
  })();
</script>
</body>
</html>
